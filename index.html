import React, { useState, useEffect, useRef } from 'react';
import { FileText, Link, Bot, MessageSquare, ListChecks, Settings, Mic, Send, X, Download, Copy, ChevronLeft, ChevronRight, Play, Loader2, User, Cpu, Check, KeyRound, Volume2 } from 'lucide-react';

// Helper Components

const IconWrapper = ({ icon: Icon, className = '' }) => (
    <div className={`bg-indigo-100 text-indigo-600 rounded-lg p-3 inline-flex ${className}`}>
        <Icon className="w-6 h-6" />
    </div>
);

const Card = ({ children, className = '' }) => (
    <div className={`bg-white border border-gray-200 rounded-xl shadow-sm p-6 md:p-8 ${className}`}>
        {children}
    </div>
);

const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false }) => {
    const baseStyles = 'px-4 py-2 rounded-lg font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-200 inline-flex items-center justify-center gap-2';
    const variants = {
        primary: 'bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500',
        secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300 focus:ring-gray-400',
        ghost: 'bg-transparent text-indigo-600 hover:bg-indigo-50 focus:ring-indigo-500',
    };
    return (
        <button onClick={onClick} className={`${baseStyles} ${variants[variant]} ${className}`} disabled={disabled}>
            {children}
        </button>
    );
};

const ProgressBar = ({ currentStep, totalSteps }) => {
    const progress = (currentStep / totalSteps) * 100;
    const steps = ["Knowledge", "Persona", "Voice", "Greeting", "Criteria", "Settings", "Deploy"];
    return (
        <div className="mb-8">
            <div className="flex justify-between mb-2 text-sm font-medium text-gray-600">
                {steps.map((step, index) => (
                    <div key={step} className={`w-1/${totalSteps} text-center ${index + 1 <= currentStep ? 'text-indigo-600' : 'text-gray-400'}`}>
                        {step}
                    </div>
                ))}
            </div>
            <div className="w-full bg-gray-200 rounded-full h-2.5">
                <div className="bg-indigo-600 h-2.5 rounded-full transition-all duration-500" style={{ width: `${progress}%` }}></div>
            </div>
        </div>
    );
};

// Step Components

const KnowledgeBaseStep = ({ data, setData }) => {
    const [activeTab, setActiveTab] = useState(data.type || 'text');

    const handleTabClick = (tab) => {
        setActiveTab(tab);
        setData({ ...data, type: tab, content: '' });
    };

    const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                setData({ ...data, content: event.target.result, file: file });
            };
            reader.readAsText(file);
        }
    };

    return (
        <Card>
            <IconWrapper icon={FileText} />
            <h2 className="text-2xl font-bold text-gray-800 mt-4">Build Your Knowledge Base</h2>
            <p className="text-gray-600 mt-2">Provide the context for the AI. This is the information it will use to answer questions during the simulation.</p>
            <div className="mt-6">
                <div className="border-b border-gray-200">
                    <nav className="-mb-px flex space-x-6" aria-label="Tabs">
                        <button onClick={() => handleTabClick('text')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'text' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>Enter Text</button>
                        <button onClick={() => handleTabClick('file')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'file' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>Upload File</button>
                        <button onClick={() => handleTabClick('url')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'url' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>From URL</button>
                    </nav>
                </div>
                <div className="mt-6">
                    {activeTab === 'text' && <textarea value={data.content} onChange={e => setData({ ...data, content: e.target.value })} className="w-full h-48 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Paste your product documentation, FAQs, or any other text-based information here..."></textarea>}
                    {activeTab === 'file' && (
                        <div className="flex items-center justify-center w-full">
                            <label htmlFor="dropzone-file" className="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg className="w-8 h-8 mb-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2" /></svg>
                                    <p className="mb-2 text-sm text-gray-500"><span className="font-semibold">Click to upload</span> or drag and drop</p>
                                    <p className="text-xs text-gray-500">PDF, DOCX, TXT, CSV (MAX. 5MB)</p>
                                </div>
                                <input id="dropzone-file" type="file" className="hidden" onChange={handleFileChange} accept=".pdf,.docx,.txt,.csv" />
                                {data.file && <p className="text-sm text-green-600 mt-2">File selected: {data.file.name}</p>}
                            </label>
                        </div>
                    )}
                    {activeTab === 'url' && <input type="url" value={data.content} onChange={e => setData({ ...data, content: e.target.value })} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://example.com/knowledge-base" />}
                </div>
            </div>
        </Card>
    );
};

const PersonaStep = ({ data, setData }) => {
    const [personaType, setPersonaType] = useState(data.type || 'quick');

    const handleTypeChange = (type) => {
        setPersonaType(type);
        setData({ ...data, type: type });
    };

    const handleGuidedChange = (field, value) => {
        setData({
            ...data,
            guided: { ...data.guided, [field]: value }
        });
    };

    return (
        <Card>
            <IconWrapper icon={Bot} />
            <h2 className="text-2xl font-bold text-gray-800 mt-4">Define the AI's Persona</h2>
            <p className="text-gray-600 mt-2">Choose how to define the AI's personality. This will determine how it behaves in the simulation.</p>
            <div className="mt-6 flex gap-4 border border-gray-200 rounded-lg p-1 bg-gray-50 w-full md:w-auto">
                <Button onClick={() => handleTypeChange('quick')} variant={personaType === 'quick' ? 'primary' : 'ghost'} className="w-full">Quick Persona</Button>
                <Button onClick={() => handleTypeChange('guided')} variant={personaType === 'guided' ? 'primary' : 'ghost'} className="w-full">Guided Builder</Button>
            </div>
            <div className="mt-6">
                {personaType === 'quick' ? (
                    <div>
                        <label htmlFor="quick-persona" className="block text-sm font-medium text-gray-700">Persona Description</label>
                        <textarea id="quick-persona" value={data.quick || ''} onChange={e => setData({ ...data, quick: e.target.value })} rows="6" className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., You are Sarah, a frustrated customer whose recent order was delivered late. You are normally patient, but today you are in a hurry and want a quick resolution..."></textarea>
                    </div>
                ) : (
                    <div className="space-y-6">
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Identity & Role</label>
                            <input type="text" value={data.guided?.role || ''} onChange={e => handleGuidedChange('role', e.target.value)} placeholder="e.g., Prospective client for a software demo" className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Background & Context</label>
                            <textarea value={data.guided?.background || ''} onChange={e => handleGuidedChange('background', e.target.value)} rows="3" className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., You have been using a competitor's product for 5 years and are generally happy..."></textarea>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Objective</label>
                            <textarea value={data.guided?.objective || ''} onChange={e => handleGuidedChange('objective', e.target.value)} rows="3" className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Your goal is to understand if the new software can solve your specific reporting problem within a budget of $5,000/year."></textarea>
                        </div>
                    </div>
                )}
            </div>
        </Card>
    );
};

const VoiceStep = ({ apiKey, setApiKey, voice, setVoice }) => {
    const [voices, setVoices] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    useEffect(() => {
        if (apiKey) {
            const fetchVoices = async () => {
                setIsLoading(true);
                setError('');
                try {
                    const response = await fetch('https://api.elevenlabs.io/v1/voices', {
                        headers: { 'xi-api-key': apiKey }
                    });
                    if (!response.ok) {
                        throw new Error('Failed to fetch voices. Check your API key.');
                    }
                    const data = await response.json();
                    setVoices(data.voices);
                } catch (err) {
                    setError(err.message);
                    setVoices([]);
                } finally {
                    setIsLoading(false);
                }
            };
            fetchVoices();
        }
    }, [apiKey]);

    return (
        <Card>
            <IconWrapper icon={Volume2} />
            <h2 className="text-2xl font-bold text-gray-800 mt-4">Select a Voice</h2>
            <p className="text-gray-600 mt-2">Choose a voice for your AI agent from ElevenLabs. An API key is required.</p>
            
            <div className="mt-6">
                <label htmlFor="api-key" className="block text-sm font-medium text-gray-700">ElevenLabs API Key</label>
                <div className="relative mt-1">
                    <KeyRound className="pointer-events-none absolute top-1/2 transform -translate-y-1/2 left-3 h-5 w-5 text-gray-400" />
                    <input type="password" id="api-key" value={apiKey} onChange={e => setApiKey(e.target.value)} className="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm pl-10" placeholder="Enter your API key" />
                </div>
            </div>

            <div className="mt-6">
                <h3 className="text-lg font-medium text-gray-800">Available Voices</h3>
                {isLoading && <div className="flex items-center mt-2 text-gray-500"><Loader2 className="animate-spin mr-2" /> Fetching voices...</div>}
                {error && <div className="mt-2 text-red-600">{error}</div>}
                <div className="mt-4 max-h-60 overflow-y-auto border border-gray-200 rounded-lg">
                    <ul className="divide-y divide-gray-200">
                        {voices.map(v => (
                            <li key={v.voice_id} className={`p-3 flex justify-between items-center ${voice.voice_id === v.voice_id ? 'bg-indigo-50' : ''}`}>
                                <div>
                                    <p className="font-semibold text-gray-800">{v.name}</p>
                                    <p className="text-sm text-gray-500">{v.labels.accent || 'N/A'} - {v.labels.gender || 'N/A'}</p>
                                </div>
                                <Button onClick={() => setVoice(v)} variant={voice.voice_id === v.voice_id ? 'primary' : 'secondary'} disabled={!apiKey}>
                                    {voice.voice_id === v.voice_id ? 'Selected' : 'Select'}
                                </Button>
                            </li>
                        ))}
                    </ul>
                </div>
            </div>
        </Card>
    );
};


const GreetingStep = ({ data, setData }) => (
    <Card>
        <IconWrapper icon={MessageSquare} />
        <h2 className="text-2xl font-bold text-gray-800 mt-4">Set the First Message</h2>
        <p className="text-gray-600 mt-2">This is the first thing the AI will say to start the simulation. You can use `[LearnerName]` as a placeholder.</p>
        <div className="mt-6">
            <label htmlFor="greeting" className="block text-sm font-medium text-gray-700">Greeting Message</label>
            <input type="text" id="greeting" value={data} onChange={e => setData(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Hi [LearnerName], thanks for calling support. How can I help?" />
        </div>
    </Card>
);

const CriteriaStep = ({ data, setData }) => {
    const addCriterion = () => {
        setData([...data, { name: '', definition: '' }]);
    };
    const updateCriterion = (index, field, value) => {
        const newData = [...data];
        newData[index][field] = value;
        setData(newData);
    };
    const removeCriterion = (index) => {
        setData(data.filter((_, i) => i !== index));
    };

    return (
        <Card>
            <IconWrapper icon={ListChecks} />
            <h2 className="text-2xl font-bold text-gray-800 mt-4">Define Evaluation Criteria</h2>
            <p className="text-gray-600 mt-2">Set the criteria for success. The AI will use these to evaluate the learner's performance after the simulation.</p>
            <div className="mt-6 space-y-4">
                {data.map((criterion, index) => (
                    <div key={index} className="p-4 border border-gray-200 rounded-lg bg-gray-50 relative">
                        <button onClick={() => removeCriterion(index)} className="absolute top-2 right-2 text-gray-400 hover:text-gray-600"><X size={18} /></button>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Criterion Name</label>
                                <input type="text" value={criterion.name} onChange={e => updateCriterion(index, 'name', e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Empathy" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Success Definition</label>
                                <textarea value={criterion.definition} onChange={e => updateCriterion(index, 'definition', e.target.value)} rows="3" className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Learner must acknowledge the customer's frustration before attempting to solve the problem."></textarea>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
            <Button onClick={addCriterion} variant="secondary" className="mt-6">Add Criterion</Button>
        </Card>
    );
};

const SettingsStep = ({ data, setData }) => (
    <Card>
        <IconWrapper icon={Settings} />
        <h2 className="text-2xl font-bold text-gray-800 mt-4">Configure Conversation Settings</h2>
        <p className="text-gray-600 mt-2">Set the time limits for the simulation to ensure it runs smoothly.</p>
        <div className="mt-6 space-y-4">
            <div>
                <label className="block text-sm font-medium text-gray-700">Turn Timeout (seconds)</label>
                <input type="number" value={data.turnTimeout} onChange={e => setData({ ...data, turnTimeout: e.target.value })} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="15" />
                <p className="mt-1 text-xs text-gray-500">Time learner has to respond before the AI prompts them.</p>
            </div>
            <div>
                <label className="block text-sm font-medium text-gray-700">Silence End Call Timeout (seconds)</label>
                <input type="number" value={data.silenceTimeout} onChange={e => setData({ ...data, silenceTimeout: e.target.value })} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="60" />
                <p className="mt-1 text-xs text-gray-500">Duration of silence before the call automatically ends.</p>
            </div>
            <div>
                <label className="block text-sm font-medium text-gray-700">Max Conversation Duration (seconds)</label>
                <input type="number" value={data.maxDuration} onChange={e => setData({ ...data, maxDuration: e.target.value })} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="600" />
                <p className="mt-1 text-xs text-gray-500">The hard limit for the entire simulation.</p>
            </div>
        </div>
    </Card>
);

const DeployStep = ({ data, onStart }) => {
    const iframeCode = `<iframe src="https://your-domain.com/widget/sim_12345" width="400" height="600" frameborder="0"></iframe>`;
    const [copied, setCopied] = useState(false);

    const copyToClipboard = () => {
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = iframeCode;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        document.execCommand('copy');
        document.body.removeChild(tempTextArea);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
    };
    
    return (
        <div className="space-y-8">
            <Card>
                <div className="text-center">
                    <IconWrapper icon={CheckCircle2} className="mx-auto bg-green-100 text-green-600" />
                    <h2 className="text-2xl font-bold text-gray-800 mt-4">Simulation Ready!</h2>
                    <p className="text-gray-600 mt-2">Your simulation is configured. You can now embed it or run a test.</p>
                    <Button onClick={onStart} className="mt-6">
                        <Play size={20} /> Run Test Simulation
                    </Button>
                </div>
            </Card>
            <Card>
                <h3 className="text-lg font-semibold text-gray-800">Embed Widget</h3>
                <p className="text-gray-600 mt-1">Copy and paste this code into your LMS or website to embed the simulation widget.</p>
                <div className="mt-4 p-3 bg-gray-100 rounded-lg font-mono text-sm text-gray-700 relative">
                    {iframeCode}
                    <button onClick={copyToClipboard} className="absolute top-2 right-2 p-1.5 bg-white rounded-md text-gray-500 hover:text-indigo-600 hover:bg-gray-50">
                        {copied ? <Check size={16} className="text-green-500" /> : <Copy size={16} />}
                    </button>
                </div>
            </Card>
            <Card>
                <h3 className="text-lg font-semibold text-gray-800">Configuration Summary</h3>
                <div className="mt-4 space-y-2 text-sm text-gray-700">
                    <p><strong>Knowledge Base:</strong> {data.knowledgeBase.type} - {data.knowledgeBase.content.substring(0, 50)}...</p>
                    <p><strong>Persona:</strong> {data.persona.type}</p>
                    <p><strong>Voice:</strong> {data.voice.name || 'Default'}</p>
                    <p><strong>Greeting:</strong> {data.greeting}</p>
                    <p><strong>Criteria:</strong> {data.criteria.map(c => c.name).join(', ')}</p>
                    <p><strong>Settings:</strong> Turn Timeout: {data.settings.turnTimeout}s, Silence Timeout: {data.settings.silenceTimeout}s, Max Duration: {data.settings.maxDuration}s</p>
                </div>
            </Card>
        </div>
    );
};


const SimulationWidget = ({ config, onEnd }) => {
    const [messages, setMessages] = useState([]);
    const [inputValue, setInputValue] = useState('');
    const [isListening, setIsListening] = useState(false);
    const [isThinking, setIsThinking] = useState(false);
    const [error, setError] = useState(null);
    const audioRef = useRef(null);
    const messagesEndRef = useRef(null);

    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    };

    useEffect(scrollToBottom, [messages]);
    
    const speakText = async (text) => {
        if (audioRef.current) {
            audioRef.current.pause();
        }
        
        // Use ElevenLabs if API key and voice ID are provided
        if (config.elevenLabsApiKey && config.voice?.voice_id) {
            const ELEVENLABS_API_URL = `https://api.elevenlabs.io/v1/text-to-speech/${config.voice.voice_id}`;
            try {
                const response = await fetch(ELEVENLABS_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'xi-api-key': config.elevenLabsApiKey,
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: 'eleven_multilingual_v2',
                    }),
                });

                if (!response.ok) {
                    throw new Error("Failed to get audio from ElevenLabs. Falling back to browser speech.");
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                audioRef.current = new Audio(audioUrl);
                audioRef.current.play();
                return; // Exit if ElevenLabs succeeds

            } catch (err) {
                console.error(err);
                setError("ElevenLabs failed. Using browser voice.");
                // Fallback to browser's speech synthesis
            }
        }
        
        // Fallback to browser's speech synthesis
        const utterance = new SpeechSynthesisUtterance(text);
        window.speechSynthesis.speak(utterance);
    };

    useEffect(() => {
        const greeting = config.greeting.replace('[LearnerName]', 'Learner');
        setMessages([{ sender: 'ai', text: greeting }]);
        speakText(greeting);
    }, [config.greeting]);
    
    const constructSystemPrompt = () => {
        let personaDescription = '';
        if (config.persona.type === 'quick') {
            personaDescription = config.persona.quick;
        } else {
            const { role, background, objective } = config.persona.guided;
            personaDescription = `You are playing the role of: ${role}. Your background is: ${background}. Your main objective is: ${objective}.`;
        }

        let knowledgeInfo = '';
        if (config.knowledgeBase.content) {
            knowledgeInfo = `You must use the following information from your knowledge base to answer questions: "${config.knowledgeBase.content}"`;
        }

        return `You are an AI actor in a training simulation. You must strictly adhere to the following persona and instructions at all times. **Your Persona:** ${personaDescription} **Your Knowledge Base:** ${knowledgeInfo} **Instructions:** - Stay in character at all times. Do not reveal that you are an AI. - Use the provided knowledge base to answer any relevant questions. If the information is not in your knowledge base, you can say you don't know. - Respond naturally based on your persona's background and objectives.`;
    };

    const handleSend = async () => {
        if (!inputValue.trim() || isThinking) return;
        
        const userMessage = { sender: 'user', text: inputValue };
        const newMessages = [...messages, userMessage];
        setMessages(newMessages);
        setInputValue('');
        setIsThinking(true);
        setError(null);

        const systemPrompt = constructSystemPrompt();
        const history = newMessages.map(msg => ({
            role: msg.sender === 'ai' ? 'model' : 'user',
            parts: [{ text: msg.text }]
        }));

        const payload = {
            contents: [
                { role: 'user', parts: [{ text: systemPrompt }] },
                { role: 'model', parts: [{ text: "Understood. I am ready to begin the simulation." }] },
                ...history
            ]
        };

        try {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);

            const result = await response.json();
            const aiResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (aiResponseText) {
                setMessages([...newMessages, { sender: 'ai', text: aiResponseText }]);
                speakText(aiResponseText);
            } else {
                throw new Error("Received an empty response from the AI.");
            }
        } catch (e) {
            console.error("Failed to get AI response:", e);
            const errorMessage = "Sorry, I'm having trouble responding right now. Please try again in a moment.";
            setError(errorMessage);
            setMessages([...newMessages, { sender: 'ai', text: errorMessage }]);
        } finally {
            setIsThinking(false);
        }
    };
    
    const handleMicClick = () => {
        if (!('webkitSpeechRecognition' in window)) {
            alert("Speech recognition is not supported in your browser.");
            return;
        }
        
        const recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onstart = () => setIsListening(true);
        recognition.onend = () => setIsListening(false);
        recognition.onerror = (event) => {
            console.error("Speech recognition error", event);
            setIsListening(false);
        };
        
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            setInputValue(transcript);
        };

        if (isListening) {
            recognition.stop();
        } else {
            recognition.start();
        }
    };

    return (
        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md h-[700px] max-h-[90vh] flex flex-col overflow-hidden">
                <div className="p-4 border-b border-gray-200 flex justify-between items-center">
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white">
                            <Bot size={24} />
                        </div>
                        <div>
                            <h3 className="font-bold text-gray-800">{config.persona.guided?.role || 'AI Persona'}</h3>
                            <div className="flex items-center gap-1.5">
                                <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                <p className="text-xs text-gray-500">Live</p>
                            </div>
                        </div>
                    </div>
                    <button onClick={() => onEnd(messages)} className="text-gray-400 hover:text-gray-600"><X size={24} /></button>
                </div>
                <div className="flex-1 p-4 overflow-y-auto bg-gray-50">
                    <div className="space-y-4">
                        {messages.map((msg, index) => (
                            <div key={index} className={`flex items-end gap-2 ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                                {msg.sender === 'ai' && <IconWrapper icon={Cpu} className="bg-gray-200 text-gray-600 p-2" />}
                                <div className={`max-w-[80%] p-3 rounded-2xl ${msg.sender === 'user' ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white text-gray-800 border border-gray-200 rounded-bl-none'}`}>
                                    <p className="text-sm">{msg.text}</p>
                                </div>
                                {msg.sender === 'user' && <IconWrapper icon={User} className="p-2" />}
                            </div>
                        ))}
                        {isThinking && (
                             <div className="flex items-end gap-2 justify-start">
                                <IconWrapper icon={Cpu} className="bg-gray-200 text-gray-600 p-2" />
                                <div className="max-w-[80%] p-3 rounded-2xl bg-white text-gray-800 border border-gray-200 rounded-bl-none">
                                    <div className="flex items-center gap-2">
                                        <div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce"></div>
                                        <div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce delay-75"></div>
                                        <div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce delay-150"></div>
                                    </div>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>
                </div>
                <div className="p-4 border-t border-gray-200 bg-white">
                    {error && <p className="text-xs text-red-500 text-center mb-2">{error}</p>}
                    <div className="flex items-center gap-2">
                        <button onClick={handleMicClick} className={`p-2 rounded-full ${isListening ? 'bg-red-500 text-white animate-pulse' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}>
                            <Mic size={20} />
                        </button>
                        <input
                            type="text"
                            value={inputValue}
                            onChange={e => setInputValue(e.target.value)}
                            onKeyPress={e => e.key === 'Enter' && handleSend()}
                            placeholder="Type or speak your message..."
                            className="flex-1 p-2 border border-gray-300 rounded-full focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            disabled={isThinking}
                        />
                        <button onClick={handleSend} className="p-3 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 disabled:bg-indigo-300" disabled={!inputValue.trim() || isThinking}>
                            <Send size={20} />
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};

const ReportScreen = ({ config, transcript, onBack }) => {
    const reportRef = useRef();
    const [scriptsLoaded, setScriptsLoaded] = useState(false);
    const [evaluations, setEvaluations] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);

    useEffect(() => {
        const loadScript = (src, onLoad) => {
            const existingScript = document.querySelector(`script[src="${src}"]`);
            if (existingScript) {
                onLoad();
                return existingScript;
            }
            const script = document.createElement('script');
            script.src = src;
            script.onload = onLoad;
            script.onerror = () => console.error(`Failed to load script: ${src}`);
            document.body.appendChild(script);
            return script;
        };

        let jspdfScript, html2canvasScript;
        
        html2canvasScript = loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js', () => {
            jspdfScript = loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', () => {
                setScriptsLoaded(true);
            });
        });

        return () => {
            if (jspdfScript?.parentNode) document.body.removeChild(jspdfScript);
            if (html2canvasScript?.parentNode) document.body.removeChild(html2canvasScript);
        };
    }, []);

    useEffect(() => {
        const generateEvaluations = async () => {
            setIsLoading(true);
            setError(null);
            
            const fullTranscriptText = transcript.map(msg => `${msg.sender === 'ai' ? 'AI' : 'Learner'}: ${msg.text}`).join('\n');
            const newEvaluations = [];

            for (const criterion of config.criteria) {
                const prompt = `
                    Based on the following conversation transcript, please evaluate if the learner met the criterion: "${criterion.name}".
                    The definition for success is: "${criterion.definition}".
                    
                    First, respond with only "Met", "Partially Met", or "Not Met".
                    Then, on a new line, provide a brief, one-sentence overview explaining your reasoning.
                    
                    Transcript:
                    ${fullTranscriptText}
                `;
                
                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // Provided by environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                        const text = result.candidates[0].content.parts[0].text;
                        const [status, ...overviewParts] = text.split('\n');
                        const overview = overviewParts.join('\n').trim();
                        newEvaluations.push({ name: criterion.name, status: status.trim(), overview: overview });
                    } else {
                         throw new Error("Invalid response structure from API.");
                    }

                } catch (e) {
                    console.error("Evaluation error for criterion:", criterion.name, e);
                    newEvaluations.push({ name: criterion.name, status: "Error", overview: "Could not evaluate this criterion due to an API error." });
                    setError("There was an issue generating the full report with AI. Displaying partial results.");
                }
            }
            setEvaluations(newEvaluations);
            setIsLoading(false);
        };

        if (config.criteria.length > 0) {
            generateEvaluations();
        } else {
            setIsLoading(false);
        }
    }, [config, transcript]);

    const downloadPdf = () => {
        if (!scriptsLoaded || !window.jspdf || !window.html2canvas) {
            console.error("PDF generation scripts not loaded yet.");
            alert("PDF generator is still loading, please wait a moment and try again.");
            return;
        }
        const input = reportRef.current;
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        window.html2canvas(input, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;
            const ratio = canvasWidth / canvasHeight;
            const width = pdfWidth;
            const height = width / ratio;
            
            let position = 0;
            let heightLeft = height;

            pdf.addImage(imgData, 'PNG', 0, position, width, height);
            heightLeft -= pdfHeight;

            while (heightLeft > 0) {
                position = heightLeft - height;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, width, height);
                heightLeft -= pdfHeight;
            }
            pdf.save("simulation-report.pdf");
        });
    };

    const getStatusColor = (status) => {
        switch (status) {
            case 'Met': return 'bg-green-100 text-green-800';
            case 'Partially Met': return 'bg-yellow-100 text-yellow-800';
            case 'Not Met': return 'bg-red-100 text-red-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    };

    return (
        <div className="bg-gray-50 min-h-screen p-4 sm:p-6 lg:p-8">
            <div className="max-w-4xl mx-auto">
                <div className="flex justify-between items-center mb-6">
                    <Button onClick={onBack} variant="secondary"><ChevronLeft size={20} /> Back to Builder</Button>
                    <Button onClick={downloadPdf} disabled={!scriptsLoaded}>
                        {!scriptsLoaded ? <Loader2 size={20} className="animate-spin" /> : <Download size={20} />}
                        {scriptsLoaded ? 'Download PDF' : 'Loading...'}
                    </Button>
                </div>
                
                <div ref={reportRef} className="bg-white p-8 md:p-12 rounded-lg shadow-lg">
                    <h1 className="text-3xl font-bold text-gray-900 border-b pb-4">Simulation Report</h1>
                    <div className="grid md:grid-cols-3 gap-6 my-6 text-sm">
                        <div><strong>Learner:</strong> Jane Doe</div>
                        <div><strong>Date:</strong> {new Date().toLocaleDateString()}</div>
                        <div><strong>Status:</strong> Completed</div>
                    </div>

                    <h2 className="text-xl font-semibold text-gray-800 mt-10 mb-4">Evaluation Summary</h2>
                    {isLoading ? (
                        <div className="flex items-center justify-center p-8 bg-gray-50 rounded-lg">
                            <Loader2 className="animate-spin mr-2 text-indigo-600" />
                            <span className="text-gray-600">Generating AI evaluation...</span>
                        </div>
                    ) : error ? (
                         <div className="p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg">{error}</div>
                    ) : (
                        <div className="space-y-4">
                            {evaluations.map((ev, i) => (
                                <div key={i} className="p-4 rounded-lg border border-gray-200">
                                    <div className="flex justify-between items-start">
                                        <h3 className="font-semibold text-gray-800">{ev.name}</h3>
                                        <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(ev.status)}`}>{ev.status}</span>
                                    </div>
                                    <p className="text-gray-600 mt-2 text-sm">{ev.overview}</p>
                                </div>
                            ))}
                        </div>
                    )}

                    <h2 className="text-xl font-semibold text-gray-800 mt-10 mb-4">Full Transcription</h2>
                    <div className="space-y-4 border border-gray-200 rounded-lg p-4 max-h-96 overflow-y-auto bg-gray-50">
                        {transcript.map((msg, index) => (
                            <div key={index} className={`flex items-start gap-3 ${msg.sender === 'user' ? 'justify-end' : ''}`}>
                                {msg.sender === 'ai' && <div className="flex-shrink-0 w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center font-bold text-sm text-gray-600">AI</div>}
                                <div className={`p-3 rounded-lg max-w-lg ${msg.sender === 'user' ? 'bg-indigo-100 text-indigo-900' : 'bg-gray-200 text-gray-800'}`}>
                                    <p className="text-sm">{msg.text}</p>
                                </div>
                                {msg.sender === 'user' && <div className="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center font-bold text-sm text-white">L</div>}
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    );
};

// Main App Component
export default function App() {
    const [step, setStep] = useState(1);
    const [knowledgeBase, setKnowledgeBase] = useState({ type: 'text', content: '', file: null });
    const [persona, setPersona] = useState({ type: 'quick', quick: 'You are a helpful and friendly assistant.', guided: { role: '', background: '', objective: '' } });
    const [elevenLabsApiKey, setElevenLabsApiKey] = useState('');
    const [voice, setVoice] = useState({});
    const [greeting, setGreeting] = useState('Hi [LearnerName], thanks for getting in touch. How can I help you today?');
    const [criteria, setCriteria] = useState([{ name: 'Empathy', definition: 'The learner must acknowledge the customer\'s feelings before trying to solve the problem.' }]);
    const [settings, setSettings] = useState({ turnTimeout: 15, silenceTimeout: 60, maxDuration: 600 });

    const [isSimulating, setIsSimulating] = useState(false);
    const [showReport, setShowReport] = useState(false);
    const [transcript, setTranscript] = useState([]);

    const totalSteps = 7;

    const handleNext = () => setStep(prev => Math.min(prev + 1, totalSteps));
    const handleBack = () => setStep(prev => Math.max(prev - 1, 1));

    const handleStartSimulation = () => {
        setIsSimulating(true);
    };

    const handleEndSimulation = (finalTranscript) => {
        setTranscript(finalTranscript);
        setIsSimulating(false);
        setShowReport(true);
    };
    
    const handleBackToBuilder = () => {
        setShowReport(false);
        setTranscript([]);
        setStep(totalSteps); // Go back to the deploy step
    };

    const renderStep = () => {
        const fullConfig = { knowledgeBase, persona, elevenLabsApiKey, voice, greeting, criteria, settings };
        switch (step) {
            case 1: return <KnowledgeBaseStep data={knowledgeBase} setData={setKnowledgeBase} />;
            case 2: return <PersonaStep data={persona} setData={setPersona} />;
            case 3: return <VoiceStep apiKey={elevenLabsApiKey} setApiKey={setElevenLabsApiKey} voice={voice} setVoice={setVoice} />;
            case 4: return <GreetingStep data={greeting} setData={setGreeting} />;
            case 5: return <CriteriaStep data={criteria} setData={setCriteria} />;
            case 6: return <SettingsStep data={settings} setData={setSettings} />;
            case 7: return <DeployStep data={fullConfig} onStart={handleStartSimulation} />;
            default: return <div>Unknown Step</div>;
        }
    };
    
    if (isSimulating) {
        const fullConfig = { knowledgeBase, persona, elevenLabsApiKey, voice, greeting };
        return <SimulationWidget config={fullConfig} onEnd={handleEndSimulation} />;
    }
    
    if (showReport) {
        const fullConfig = { knowledgeBase, persona, elevenLabsApiKey, voice, greeting, criteria, settings };
        return <ReportScreen config={fullConfig} transcript={transcript} onBack={handleBackToBuilder} />;
    }

    return (
        <div className="bg-gray-50 min-h-screen font-sans">
            <div className="container mx-auto px-4 py-8 md:py-12">
                <div className="max-w-3xl mx-auto">
                    <div className="text-center mb-8">
                        <h1 className="text-4xl font-extrabold text-gray-900 tracking-tight">SimuLearn AI Builder</h1>
                        <p className="mt-2 text-lg text-gray-600">Create powerful conversational simulations in minutes.</p>
                    </div>
                    
                    {step <= totalSteps && <ProgressBar currentStep={step} totalSteps={totalSteps} />}
                    
                    <div className="mt-8">
                        {renderStep()}
                    </div>
                    
                    <div className="mt-8 flex justify-between items-center">
                        <Button onClick={handleBack} variant="secondary" disabled={step === 1}>
                            <ChevronLeft size={20} /> Back
                        </Button>
                        <Button onClick={handleNext} disabled={step === totalSteps}>
                            Next <ChevronRight size={20} />
                        </Button>
                    </div>
                </div>
            </div>
        </div>
    );
}

// Dummy icon for DeployStep to avoid breaking the app
const CheckCircle2 = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/>
        <path d="m9 12 2 2 4-4"/>
    </svg>
);
